<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card shadow-sm border-0">
        <div
          class="card-header py-3"
          style="background-color: #517fb0; color: white"
        >
          <h2 class="m-0">Appointments</h2>
        </div>
        <div class="card-body">
          @if (clientSessions && clientSessions.length > 0) {
          <div class="row">
            <!-- Appointment Card 1 -->
            @for (session of clientSessions; track session.id) { @if
            (!shouldShowButtons(session.status) ) {
            <div class="col-lg-4 col-md-6 mb-4">
              <div
                class="card appointment-card h-100 shadow-sm border-0"
                style="background-color: #f8f9fa"
              >
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-start mb-3"
                  >
                    <div>
                      <h5 class="card-title mb-1 text-dark">
                        Dr. {{session.doctorName}}
                      </h5>
                      <p class="card-text text-muted small mb-2">
                        {{session.doctorspecialization}}
                      </p>
                    </div>
                    <img
                      src="{{apiUrl}}{{session.userImagePath}}"
                      alt="Doctor"
                      class="user-avatar rounded-circle"
                      style="width: 50px; height: 50px; object-fit: cover"
                    />
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <div>
                      <i
                        class="far fa-calendar-alt me-2"
                        style="color: #517fb0"
                      ></i>
                      <span class="text-muted"
                        >{{ formatDate(session.startDateTime) }}</span
                      >
                    </div>
                    <span
                      class="badge rounded-pill"
                      [ngStyle]="{'background-color': session.status === 'Canceled' ? '#dc3545' : session.status === 'Posponed' ? '#ffc107' : '#8cc2a7', color: session.status === 'Posponed' ? '#000' : '#fff'}"
                      >{{session.status}}</span
                    >
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <span
                      class="badge rounded-pill"
                      style="background-color: #e9f5f0; color: #8cc2a7"
                    >
                      <i class="fas fa-video me-1"></i> {{session.type}}
                    </span>
                    <span
                      class="badge rounded-pill"
                      style="background-color: #f1f8ff; color: #517fb0"
                    >
                      <i class="fas fa-clock me-1"></i> {{
                      formatDuration(session.duration) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            }@else if (session.status === Posponed) {
            <div class="col-lg-4 col-md-6 mb-4">
              <div
                class="card appointment-card h-100 shadow-sm border-0"
                style="background-color: #fff8e6"
              >
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-start mb-3"
                  >
                    <div>
                      <h5 class="card-title mb-1 text-dark">
                        Dr. {{session.doctorName}}
                      </h5>
                      <p class="card-text text-muted small mb-2">
                        {{session.doctorspecialization}}
                      </p>
                    </div>
                    <img
                      src="{{apiUrl}}{{session.userImagePath}}"
                      alt="Doctor"
                      class="user-avatar rounded-circle"
                      style="width: 50px; height: 50px; object-fit: cover"
                    />
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <div>
                      <i
                        class="far fa-calendar-alt me-2"
                        style="color: #517fb0"
                      ></i>
                      <span class="text-muted"
                        >{{ formatDate(session.startDateTime) }}</span
                      >
                    </div>
                    <span class="badge rounded-pill bg-warning text-dark"
                      >{{session.status}}</span
                    >
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <span
                      class="badge rounded-pill"
                      style="background-color: #e9f5f0; color: #8cc2a7"
                    >
                      <i class="fas fa-video me-1"></i> {{session.type}}
                    </span>
                    <span
                      class="badge rounded-pill"
                      style="background-color: #f1f8ff; color: #517fb0"
                    >
                      <i class="fas fa-clock me-1"></i> {{
                      formatDuration(session.duration) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            }@else if (isSessionNotPast(session)&& session.status == state) {
            <div class="col-lg-4 col-md-6 mb-4">
              <div
                class="card appointment-card h-100 shadow-sm border-0"
                style="background-color: #f0f7ff"
              >
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-start mb-3"
                  >
                    <div>
                      <h5 class="card-title mb-1" style="color: #517fb0">
                        Dr. {{session.doctorName}}
                      </h5>
                      <p class="card-text text-muted small mb-2">
                        {{session.doctorspecialization}}
                      </p>
                    </div>
                    <img
                      src="{{apiUrl}}{{session.userImagePath}}"
                      alt="Doctor"
                      class="user-avatar rounded-circle"
                      style="width: 50px; height: 50px; object-fit: cover"
                    />
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <div>
                      <i
                        class="far fa-calendar-alt me-2"
                        style="color: #517fb0"
                      ></i>
                      <span class="text-muted"
                        >{{ formatDate(session.startDateTime) }}</span
                      >
                    </div>
                    <span
                      class="badge rounded-pill"
                      style="background-color: #8cc2a7; color: white"
                      >{{session.status}}</span
                    >
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <span
                      class="badge rounded-pill"
                      style="background-color: #e9f5f0; color: #8cc2a7"
                    >
                      <i class="fas fa-video me-1"></i> {{session.type}}
                    </span>
                    <span
                      class="badge rounded-pill"
                      style="background-color: #f1f8ff; color: #517fb0"
                    >
                      <i class="fas fa-clock me-1"></i> {{
                      formatDuration(session.duration) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            }@else {
            <div class="col-lg-4 col-md-6 mb-4">
              <div
                class="card appointment-card h-100 shadow-sm border-0"
                style="background-color: white"
              >
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-start mb-3"
                  >
                    <div>
                      <h5 class="card-title mb-1" style="color: #517fb0">
                        Dr. {{session.doctorName}}
                      </h5>
                      <p class="card-text text-muted small mb-2">
                        {{session.doctorspecialization}}
                      </p>
                    </div>
                    <img
                      src="{{apiUrl}}{{session.userImagePath}}"
                      alt="Doctor"
                      class="user-avatar rounded-circle"
                      style="width: 50px; height: 50px; object-fit: cover"
                    />
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <div>
                      <i
                        class="far fa-calendar-alt me-2"
                        style="color: #517fb0"
                      ></i>
                      <span class="text-muted"
                        >{{ formatDate(session.startDateTime) }}</span
                      >
                    </div>
                    <span
                      class="badge rounded-pill"
                      style="background-color: #8cc2a7; color: white"
                      >{{session.status}}</span
                    >
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <span
                      class="badge rounded-pill"
                      style="background-color: #e9f5f0; color: #8cc2a7"
                    >
                      <i class="fas fa-video me-1"></i> {{session.type}}
                    </span>
                    <span
                      class="badge rounded-pill"
                      style="background-color: #f1f8ff; color: #517fb0"
                    >
                      <i class="fas fa-clock me-1"></i> {{
                      formatDuration(session.duration) }}
                    </span>
                  </div>

                  <div
                    class="d-flex flex-wrap gap-2 justify-content-end"
                    *ngIf="session.status !== 'Canceled' && session.status !== 'Posponed' && !isSessionNotPast(session)"
                  >
                    <!-- لو أوفلاين -->
                    <button
                      *ngIf="session.type === 'Offline'"
                      class="btn btn-sm btn-outline-secondary me-md-2"
                    >
                      <i class="fas fa-map-marker-alt me-1"></i> Clinic
                      Directions
                    </button>

                    <!-- تأجيل -->
                    <button
                      class="btn btn-sm"
                      style="
                        background-color: #fff8e6;
                        color: #ffc107;
                        border-color: #ffc107;
                      "
                      data-bs-toggle="modal"
                      data-bs-target="#postponeModal"
                      (click)="openCancelModal(session)"
                    >
                      <i class="fas fa-calendar-plus me-1"></i> Postpone
                    </button>

                    <!-- إلغاء -->
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="openCancelModal(session)"
                      data-bs-toggle="modal"
                      data-bs-target="#cancelModal"
                    >
                      <i class="fas fa-times me-1"></i> Cancel
                    </button>
                  </div>

                  <!-- لو Online وفاضل عليها ≤ 10 دقايق -->
                  <!-- && isBefore10Minutes(session) && !isSessionPast(session) -->
                  <div
                    *ngIf="session.type === 'Online' && isBefore10Minutes(session) && !isSessionNotPast(session) "
                  >
                  <button class="join-session-btn" [routerLink]="['/meeting', session.id]">
  <i class="bi bi-camera-video-fill"></i>
  <span>Join Session</span>
</button>
                  </div>
                </div>
              </div>
            </div>
           
            
            } }
          </div>
          } @else {
          <div class="text-center py-5">
            <i
              class="far fa-calendar-times fa-3x mb-3"
              style="color: #517fb0"
            ></i>
            <h5 class="text-muted">No Appointments Found</h5>
            <p class="text-muted">
              You don't have any upcoming appointments scheduled.
            </p>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

 <div
              class="modal fade"
              id="cancelModal"
              tabindex="-1"
              aria-labelledby="cancelModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div
                    class="modal-header"
                    style="background-color: #517fb0; color: white"
                  >
                    <h5 class="modal-title" id="cancelModalLabel">
                      Cancel Appointment
                    </h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      Are you sure you want to cancel your appointment with
                      <strong>Dr. {{selectedsession?.doctorName}}</strong> on
                      <strong
                        >{{formatDate(selectedsession?.startDateTime!)}}
                        ?</strong
                      >
                    </p>
                    <div class="mb-3">
                      <label for="cancelReason" class="form-label"
                        >Reason for cancellation (optional)</label
                      >
                      <textarea
                        class="form-control"
                        [(ngModel)]="reason"
                        id="cancelReason"
                        rows="3"
                      ></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Close
                    </button>
                    <button
                      type="button"
                      class="btn btn-danger"
                      data-bs-dismiss="modal"
                      (click)="SendCancelRequest()"
                    >
                      Confirm Cancellation
                    </button>
                  </div>
                </div>
              </div>
            </div>

<div
              class="modal fade"
              id="postponeModal"
              tabindex="-1"
              aria-labelledby="postponeModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div
                    class="modal-header"
                    style="background-color: #517fb0; color: white"
                  >
                    <h5 class="modal-title" id="postponeModalLabel">
                      Postpone Appointment
                    </h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      Your current appointment is with
                      <strong>Dr. {{selectedsession?.doctorName!}}</strong> on
                      <strong
                        >{{formatDate(selectedsession?.startDateTime!)}}</strong
                      >.
                    </p>
                    <div class="mb-3">
                      <label for="postponeReason" class="form-label"
                        >Reason for postponement (optional)</label
                      >
                      <textarea
                        class="form-control"
                        [(ngModel)]="reason"
                        id="postponeReason"
                        rows="3"
                      ></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Close
                    </button>
                    <button
                      type="button"
                      class="btn btn-warning"
                      (click)="SendPostponementRequest()"
                      data-bs-dismiss="modal"
                    >
                      Request Postponement
                    </button>
                  </div>
                </div>
              </div>
            </div>